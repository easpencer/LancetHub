'use client';

import { useEffect, useState } from 'react';
import dynamic from 'next/dynamic';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { FaGlobe, FaExclamationTriangle, FaChartLine, FaHospital, FaUsers, FaShieldAlt, FaExpand } from 'react-icons/fa';
import AnimatedSection from '../../components/AnimatedSection';
import LoadingState from '../../components/LoadingState';
import styles from './pandemic-vulnerability.module.css';

// Dynamically import enhanced map component to avoid SSR issues
const EnhancedPandemicMap = dynamic(() => import('./EnhancedPandemicMap'), {
  ssr: false,
  loading: () => <LoadingState message="Loading Enhanced Pandemic Map..." />
});

// Dynamic chart import
const VulnerabilityChart = dynamic(() => import('./VulnerabilityChart'), {
  ssr: false,
  loading: () => <div className={styles.chartLoading}>Loading chart...</div>
});

export default function PandemicVulnerability() {
  const [selectedScenario, setSelectedScenario] = useState('current');
  const [isOptimistic, setIsOptimistic] = useState(true);
  const [selectedCountry, setSelectedCountry] = useState(null);
  const [stats, setStats] = useState({
    totalCountries: 0,
    highRiskCount: 0,
    avgVulnerability: 0,
    healthcareGap: 0,
    totalOutbreaks: 20,
    bsl4Labs: 15,
    trackingDiseases: 25
  });

  // Mock data - in production, this would come from an API
  const vulnerabilityData = {
    current: {
      countries: 195,
      highRisk: 67,
      avgScore: 52.3,
      gap: 145
    },
    '2030': {
      countries: 195,
      highRisk: 78,
      avgScore: 58.7,
      gap: 285
    },
    '2050': {
      countries: 195,
      highRisk: 92,
      avgScore: 64.2,
      gap: 450
    }
  };

  useEffect(() => {
    // Update stats based on scenario
    const data = vulnerabilityData[selectedScenario];
    setStats({
      totalCountries: data.countries,
      highRiskCount: data.highRisk,
      avgVulnerability: data.avgScore,
      healthcareGap: data.gap
    });
  }, [selectedScenario]);

  return (
    <div className={styles.container}>
      {/* Header */}
      <header className={styles.header}>
        <div className={styles.headerContent}>
          <div>
            <h1 className={styles.title}>Global Pandemic Intelligence Platform</h1>
            <p className={styles.subtitle}>
              Comprehensive tracking of emerging diseases, BSL-4 laboratories, outbreak patterns, and pandemic preparedness worldwide
            </p>
          </div>
          <div className={styles.headerControls}>
            <div className={styles.scenarioSelector}>
              <button 
                className={`${styles.scenarioBtn} ${selectedScenario === 'current' ? styles.active : ''}`}
                onClick={() => setSelectedScenario('current')}
              >
                Current
              </button>
              <button 
                className={`${styles.scenarioBtn} ${selectedScenario === '2030' ? styles.active : ''}`}
                onClick={() => setSelectedScenario('2030')}
              >
                2030
              </button>
              <button 
                className={`${styles.scenarioBtn} ${selectedScenario === '2050' ? styles.active : ''}`}
                onClick={() => setSelectedScenario('2050')}
              >
                2050
              </button>
            </div>
            <div className={styles.projectionToggle}>
              <label className={styles.toggleSwitch}>
                <input 
                  type="checkbox" 
                  checked={!isOptimistic}
                  onChange={(e) => setIsOptimistic(!e.target.checked)}
                />
                <span className={styles.toggleSlider}></span>
                <span className={styles.toggleLabel}>Optimistic</span>
                <span className={styles.toggleLabel}>Pessimistic</span>
              </label>
            </div>
            <Link href="/pandemic-resilience-map" className={styles.deepDiveBtn}>
              <FaExpand /> Deep Dive
            </Link>
          </div>
        </div>
      </header>

      <AnimatedSection type="fade" className={styles.mainContent}>
        {/* Stats Cards */}
        <div className={styles.statsContainer}>
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
          >
            <FaGlobe className={styles.statIcon} />
            <div className={styles.statValue}>{stats.totalCountries}</div>
            <div className={styles.statLabel}>Countries Analyzed</div>
          </motion.div>
          
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
          >
            <FaExclamationTriangle className={styles.statIcon} style={{ color: 'var(--danger-color)' }} />
            <div className={styles.statValue}>{stats.highRiskCount}</div>
            <div className={styles.statLabel}>High Risk Countries</div>
          </motion.div>
          
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
          >
            <FaChartLine className={styles.statIcon} style={{ color: 'var(--accent-color)' }} />
            <div className={styles.statValue}>{stats.avgVulnerability.toFixed(1)}</div>
            <div className={styles.statLabel}>Average Vulnerability Score</div>
          </motion.div>
          
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.4 }}
          >
            <FaHospital className={styles.statIcon} style={{ color: 'var(--secondary-color)' }} />
            <div className={styles.statValue}>${stats.healthcareGap}B</div>
            <div className={styles.statLabel}>Healthcare Investment Gap</div>
          </motion.div>
          
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.5 }}
          >
            <FaUsers className={styles.statIcon} style={{ color: '#FF6B6B' }} />
            <div className={styles.statValue}>{stats.totalOutbreaks}</div>
            <div className={styles.statLabel}>Historical Outbreaks Tracked</div>
          </motion.div>
          
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.6 }}
          >
            <FaShieldAlt className={styles.statIcon} style={{ color: '#9C27B0' }} />
            <div className={styles.statValue}>{stats.bsl4Labs}</div>
            <div className={styles.statLabel}>BSL-4 Research Facilities</div>
          </motion.div>
        </div>

        {/* Selected Country Details */}
        {selectedCountry && (
          <motion.div 
            className={styles.countryDetails}
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
          >
            <h2 className={styles.countryName}>{selectedCountry.name}</h2>
            <div className={styles.metricsGrid}>
              <div className={styles.metricItem}>
                <div className={styles.metricLabel}>Healthcare Capacity</div>
                <div className={styles.metricValue}>{selectedCountry.healthcareCapacity || '--'}</div>
              </div>
              <div className={styles.metricItem}>
                <div className={styles.metricLabel}>Social Vulnerability</div>
                <div className={styles.metricValue}>{selectedCountry.socialVulnerability || '--'}</div>
              </div>
              <div className={styles.metricItem}>
                <div className={styles.metricLabel}>Economic Resilience</div>
                <div className={styles.metricValue}>{selectedCountry.economicResilience || '--'}</div>
              </div>
              <div className={styles.metricItem}>
                <div className={styles.metricLabel}>Overall Risk Level</div>
                <div className={`${styles.metricValue} ${styles[`risk${selectedCountry.riskLevel}`]}`}>
                  {selectedCountry.riskLevel || '--'}
                </div>
              </div>
            </div>
          </motion.div>
        )}

        {/* Dashboard Grid */}
        <div className={styles.dashboardGrid}>
          {/* Enhanced Map Container */}
          <EnhancedPandemicMap 
            scenario={selectedScenario}
            isOptimistic={isOptimistic}
            onCountrySelect={setSelectedCountry}
          />

          {/* Chart Container */}
          <div className={styles.chartContainer}>
            <div className={styles.chartHeader}>
              <h3 className={styles.chartTitle}>Healthcare Capacity vs Social Vulnerability</h3>
              <p className={styles.chartSubtitle}>Bubble size represents population affected</p>
            </div>
            <VulnerabilityChart 
              scenario={selectedScenario}
              isOptimistic={isOptimistic}
            />
          </div>
        </div>

        {/* Methodology Section */}
        <div className={styles.methodology}>
          <h3>About the Global Pandemic Intelligence Platform</h3>
          <p>
            This comprehensive platform integrates real-time tracking of emerging infectious diseases, 
            BSL-4 laboratory networks, historical outbreak patterns, and pandemic preparedness metrics. 
            Built on lessons learned from COVID-19, SARS, MERS, Ebola, and other global health emergencies, 
            it provides a holistic view of global pandemic risk and response capabilities.
          </p>
          
          <div className={styles.dimensionsGrid}>
            <div className={styles.dimensionCard}>
              <FaHospital className={styles.dimensionIcon} />
              <h4>Disease Surveillance</h4>
              <p>Tracking 25+ emerging pathogens including respiratory viruses, vector-borne diseases, hemorrhagic fevers, and antimicrobial-resistant bacteria</p>
            </div>
            <div className={styles.dimensionCard}>
              <FaUsers className={styles.dimensionIcon} />
              <h4>Research Infrastructure</h4>
              <p>Global network of 15 BSL-4 laboratories conducting high-containment research on the world's most dangerous pathogens</p>
            </div>
            <div className={styles.dimensionCard}>
              <FaShieldAlt className={styles.dimensionIcon} />
              <h4>Outbreak Intelligence</h4>
              <p>Historical analysis of 20+ major outbreaks showing transmission patterns, spread dynamics, and containment effectiveness</p>
            </div>
            <div className={styles.dimensionCard}>
              <FaChartLine className={styles.dimensionIcon} />
              <h4>Risk Assessment</h4>
              <p>Multi-dimensional vulnerability scoring incorporating healthcare capacity, social factors, economic resilience, and governance metrics</p>
            </div>
          </div>
        </div>
      </AnimatedSection>
    </div>
  );
}