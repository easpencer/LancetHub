'use client';

import { useEffect, useState } from 'react';
import dynamic from 'next/dynamic';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { FaGlobe, FaExclamationTriangle, FaChartLine, FaHospital, FaUsers, FaShieldAlt, FaExpand } from 'react-icons/fa';
import AnimatedSection from '../../components/AnimatedSection';
import LoadingState from '../../components/LoadingState';
import styles from './pandemic-vulnerability.module.css';

// Dynamically import map component to avoid SSR issues
const VulnerabilityMap = dynamic(() => import('./VulnerabilityMap'), {
  ssr: false,
  loading: () => <LoadingState message="Loading Map..." />
});

// Dynamic chart import
const VulnerabilityChart = dynamic(() => import('./VulnerabilityChart'), {
  ssr: false,
  loading: () => <div className={styles.chartLoading}>Loading chart...</div>
});

export default function PandemicVulnerability() {
  const [selectedScenario, setSelectedScenario] = useState('current');
  const [isOptimistic, setIsOptimistic] = useState(true);
  const [selectedCountry, setSelectedCountry] = useState(null);
  const [stats, setStats] = useState({
    totalCountries: 0,
    highRiskCount: 0,
    avgVulnerability: 0,
    healthcareGap: 0
  });

  // Mock data - in production, this would come from an API
  const vulnerabilityData = {
    current: {
      countries: 195,
      highRisk: 67,
      avgScore: 52.3,
      gap: 145
    },
    '2030': {
      countries: 195,
      highRisk: 78,
      avgScore: 58.7,
      gap: 285
    },
    '2050': {
      countries: 195,
      highRisk: 92,
      avgScore: 64.2,
      gap: 450
    }
  };

  useEffect(() => {
    // Update stats based on scenario
    const data = vulnerabilityData[selectedScenario];
    setStats({
      totalCountries: data.countries,
      highRiskCount: data.highRisk,
      avgVulnerability: data.avgScore,
      healthcareGap: data.gap
    });
  }, [selectedScenario]);

  return (
    <div className={styles.container}>
      {/* Header */}
      <header className={styles.header}>
        <div className={styles.headerContent}>
          <div>
            <h1 className={styles.title}>Pandemic Vulnerability Index</h1>
            <p className={styles.subtitle}>
              Assessing global preparedness and resilience in the pandemic age
            </p>
          </div>
          <div className={styles.headerControls}>
            <div className={styles.scenarioSelector}>
              <button 
                className={`${styles.scenarioBtn} ${selectedScenario === 'current' ? styles.active : ''}`}
                onClick={() => setSelectedScenario('current')}
              >
                Current
              </button>
              <button 
                className={`${styles.scenarioBtn} ${selectedScenario === '2030' ? styles.active : ''}`}
                onClick={() => setSelectedScenario('2030')}
              >
                2030
              </button>
              <button 
                className={`${styles.scenarioBtn} ${selectedScenario === '2050' ? styles.active : ''}`}
                onClick={() => setSelectedScenario('2050')}
              >
                2050
              </button>
            </div>
            <div className={styles.projectionToggle}>
              <label className={styles.toggleSwitch}>
                <input 
                  type="checkbox" 
                  checked={!isOptimistic}
                  onChange={(e) => setIsOptimistic(!e.target.checked)}
                />
                <span className={styles.toggleSlider}></span>
                <span className={styles.toggleLabel}>Optimistic</span>
                <span className={styles.toggleLabel}>Pessimistic</span>
              </label>
            </div>
            <Link href="/pandemic-resilience-map" className={styles.deepDiveBtn}>
              <FaExpand /> Deep Dive
            </Link>
          </div>
        </div>
      </header>

      <AnimatedSection type="fade" className={styles.mainContent}>
        {/* Stats Cards */}
        <div className={styles.statsContainer}>
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
          >
            <FaGlobe className={styles.statIcon} />
            <div className={styles.statValue}>{stats.totalCountries}</div>
            <div className={styles.statLabel}>Countries Analyzed</div>
          </motion.div>
          
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
          >
            <FaExclamationTriangle className={styles.statIcon} style={{ color: 'var(--danger-color)' }} />
            <div className={styles.statValue}>{stats.highRiskCount}</div>
            <div className={styles.statLabel}>High Risk Countries</div>
          </motion.div>
          
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
          >
            <FaChartLine className={styles.statIcon} style={{ color: 'var(--accent-color)' }} />
            <div className={styles.statValue}>{stats.avgVulnerability.toFixed(1)}</div>
            <div className={styles.statLabel}>Average Vulnerability Score</div>
          </motion.div>
          
          <motion.div 
            className={styles.statCard}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.4 }}
          >
            <FaHospital className={styles.statIcon} style={{ color: 'var(--secondary-color)' }} />
            <div className={styles.statValue}>${stats.healthcareGap}B</div>
            <div className={styles.statLabel}>Healthcare Investment Gap</div>
          </motion.div>
        </div>

        {/* Selected Country Details */}
        {selectedCountry && (
          <motion.div 
            className={styles.countryDetails}
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
          >
            <h2 className={styles.countryName}>{selectedCountry.name}</h2>
            <div className={styles.metricsGrid}>
              <div className={styles.metricItem}>
                <div className={styles.metricLabel}>Healthcare Capacity</div>
                <div className={styles.metricValue}>{selectedCountry.healthcareCapacity || '--'}</div>
              </div>
              <div className={styles.metricItem}>
                <div className={styles.metricLabel}>Social Vulnerability</div>
                <div className={styles.metricValue}>{selectedCountry.socialVulnerability || '--'}</div>
              </div>
              <div className={styles.metricItem}>
                <div className={styles.metricLabel}>Economic Resilience</div>
                <div className={styles.metricValue}>{selectedCountry.economicResilience || '--'}</div>
              </div>
              <div className={styles.metricItem}>
                <div className={styles.metricLabel}>Overall Risk Level</div>
                <div className={`${styles.metricValue} ${styles[`risk${selectedCountry.riskLevel}`]}`}>
                  {selectedCountry.riskLevel || '--'}
                </div>
              </div>
            </div>
          </motion.div>
        )}

        {/* Dashboard Grid */}
        <div className={styles.dashboardGrid}>
          {/* Map Container */}
          <div className={styles.mapContainer}>
            <VulnerabilityMap 
              scenario={selectedScenario}
              isOptimistic={isOptimistic}
              onCountrySelect={setSelectedCountry}
            />
            <div className={styles.mapLegend}>
              <div className={styles.legendTitle}>Vulnerability Index</div>
              <div className={styles.legendItem}>
                <div className={styles.legendColor} style={{ background: '#2E8B57' }}></div>
                <span>Very Low (0-20)</span>
              </div>
              <div className={styles.legendItem}>
                <div className={styles.legendColor} style={{ background: '#90EE90' }}></div>
                <span>Low (20-40)</span>
              </div>
              <div className={styles.legendItem}>
                <div className={styles.legendColor} style={{ background: '#FFD700' }}></div>
                <span>Medium (40-60)</span>
              </div>
              <div className={styles.legendItem}>
                <div className={styles.legendColor} style={{ background: '#FF9800' }}></div>
                <span>High (60-80)</span>
              </div>
              <div className={styles.legendItem}>
                <div className={styles.legendColor} style={{ background: '#FF4444' }}></div>
                <span>Very High (80-100)</span>
              </div>
            </div>
          </div>

          {/* Chart Container */}
          <div className={styles.chartContainer}>
            <div className={styles.chartHeader}>
              <h3 className={styles.chartTitle}>Healthcare Capacity vs Social Vulnerability</h3>
              <p className={styles.chartSubtitle}>Bubble size represents population affected</p>
            </div>
            <VulnerabilityChart 
              scenario={selectedScenario}
              isOptimistic={isOptimistic}
            />
          </div>
        </div>

        {/* Methodology Section */}
        <div className={styles.methodology}>
          <h3>About the Pandemic Vulnerability Index</h3>
          <p>
            This index integrates multiple dimensions of pandemic preparedness and resilience, 
            building on lessons learned from COVID-19 and other global health emergencies. 
            The methodology considers healthcare system capacity, social determinants of health, 
            economic resilience factors, and governance effectiveness.
          </p>
          
          <div className={styles.dimensionsGrid}>
            <div className={styles.dimensionCard}>
              <FaHospital className={styles.dimensionIcon} />
              <h4>Healthcare Systems</h4>
              <p>Hospital beds, ICU capacity, healthcare workers per capita, and testing infrastructure</p>
            </div>
            <div className={styles.dimensionCard}>
              <FaUsers className={styles.dimensionIcon} />
              <h4>Social Factors</h4>
              <p>Population density, multi-generational households, and social safety nets</p>
            </div>
            <div className={styles.dimensionCard}>
              <FaShieldAlt className={styles.dimensionIcon} />
              <h4>Governance</h4>
              <p>Policy effectiveness, public trust, and emergency response capabilities</p>
            </div>
          </div>
        </div>
      </AnimatedSection>
    </div>
  );
}